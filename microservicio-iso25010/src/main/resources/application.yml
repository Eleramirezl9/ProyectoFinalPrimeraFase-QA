server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: ${CONTEXT_PATH:/api}
    encoding:
      charset: UTF-8
      enabled: true
      force: true
      force-request: true
      force-response: true

spring:
  application:
    name: microservicio-iso25010
  
  # Configuración de base de datos H2
  datasource:
    url: ${DB_URL}
    driver-class-name: ${DB_DRIVER:org.h2.Driver}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  
  # Configuración JPA/Hibernate
  jpa:
    database-platform: ${DB_PLATFORM:org.hibernate.dialect.H2Dialect}
    hibernate:
      ddl-auto: ${DB_DDL_AUTO:create-drop}
    show-sql: ${DB_SHOW_SQL:true}
    properties:
      hibernate:
        '[format_sql]': true
        connection:
          CharSet: utf8mb4
          characterEncoding: utf8
          useUnicode: true
        jdbc:
          lob:
            non_contextual_creation: true
        default_schema: PUBLIC
    defer-datasource-initialization: true
  
  # Configuración H2 Console
  h2:
    console:
      enabled: ${H2_CONSOLE_ENABLED:true}
      path: ${H2_CONSOLE_PATH:/h2-console}
      settings:
        web-allow-others: ${H2_WEB_ALLOW_OTHERS:true}
  
  # Configuración de inicialización de datos
  sql:
    init:
      mode: always
      data-locations: classpath:data.sql
      continue-on-error: true
      encoding: UTF-8

# Configuración de logging
logging:
  level:
    '[com.ejemplo]': ${LOG_LEVEL_APP:DEBUG}
    '[org.springframework.web]': ${LOG_LEVEL_WEB:DEBUG}
    '[org.hibernate.SQL]': ${LOG_LEVEL_SQL:DEBUG}
    '[org.hibernate.type.descriptor.sql.BasicBinder]': ${LOG_LEVEL_HIBERNATE:TRACE}
    root: ${LOG_LEVEL_ROOT:INFO}

# Configuración de SpringDoc OpenAPI
springdoc:
  api-docs:
    path: ${SWAGGER_API_DOCS_PATH:/api-docs}
    enabled: ${SWAGGER_ENABLED:true}
  swagger-ui:
    path: ${SWAGGER_UI_PATH:/swagger-ui.html}
    enabled: ${SWAGGER_UI_ENABLED:true}

# Configuración de gestión y monitoreo (Spring Boot Actuator)
management:
  endpoints:
    web:
      exposure:
        include: ${ACTUATOR_ENDPOINTS:health,info,metrics,circuitbreakers,circuitbreakerevents,retries,retryevents}
  endpoint:
    health:
      show-details: ${ACTUATOR_HEALTH_DETAILS:when-authorized}
  health:
    circuitbreakers:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

# Configuración personalizada de CORS
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:4200,http://localhost:8080,http://127.0.0.1:3000,http://127.0.0.1:4200,http://127.0.0.1:8080}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,PATCH,DELETE,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:Content-Type,Authorization,X-Requested-With,Accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers}
  exposed-headers: ${CORS_EXPOSED_HEADERS:Access-Control-Allow-Origin,Access-Control-Allow-Credentials,Location,X-Total-Count}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  max-age: ${CORS_MAX_AGE:3600}

# Configuración JWT
jwt:
  secret: ${JWT_SECRET}
  expiration: ${JWT_EXPIRATION:86400000}
  refresh-token:
    expiration: ${JWT_REFRESH_TOKEN_EXPIRATION:604800000}

# Configuración de Resilience4j - Circuit Breaker, Retry, Fallback
resilience4j:
  # Circuit Breaker Configuration
  circuitbreaker:
    instances:
      pedidoService:
        registerHealthIndicator: true
        slidingWindowSize: 10                      # Ventana de 10 llamadas para evaluar
        minimumNumberOfCalls: 5                    # Mínimo 5 llamadas antes de calcular tasa de fallo
        failureRateThreshold: 50                   # 50% de fallos abre el circuito
        waitDurationInOpenState: 10s               # Espera 10s antes de pasar a HALF_OPEN
        permittedNumberOfCallsInHalfOpenState: 3   # Permite 3 llamadas en estado HALF_OPEN
        automaticTransitionFromOpenToHalfOpenEnabled: true
        slidingWindowType: COUNT_BASED

      productoService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        slidingWindowType: COUNT_BASED

  # Retry Configuration
  retry:
    instances:
      productoService:
        maxAttempts: 3                             # Máximo 3 intentos
        waitDuration: 1s                           # Espera 1 segundo entre reintentos
        retryExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:
          - jakarta.persistence.EntityNotFoundException

      pedidoService:
        maxAttempts: 3
        waitDuration: 2s
        retryExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException

  # Time Limiter Configuration
  timelimiter:
    instances:
      pedidoService:
        timeoutDuration: 5s                        # Timeout de 5 segundos
      productoService:
        timeoutDuration: 3s                        # Timeout de 3 segundos