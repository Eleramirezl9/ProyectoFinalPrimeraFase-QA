# ==========================================
# Docker Compose - PRODUCCIÓN
# ==========================================
# Uso: docker-compose up -d
#
# Stack completo para producción:
# - Jenkins CI/CD
# - Microservicio en modo producción
# - Healthchecks y redes configuradas

services:
  # ==========================================
  # JENKINS - Servidor CI/CD
  # ==========================================
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile.jenkins
    container_name: jenkins-prod
    user: root
    ports:
      - "8082:8080"      # Jenkins UI
      - "50000:50000"    # Jenkins agent port
    volumes:
      # Persistencia de configuración Jenkins
      - jenkins_home:/var/jenkins_home

      # Docker socket para builds
      - /var/run/docker.sock:/var/run/docker.sock

      # Cache de Maven
      - maven_cache:/root/.m2
    environment:
      # Configuración JVM optimizada
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false -Xmx1g -Xms512m
      - DOCKER_HOST=unix:///var/run/docker.sock
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - prod-network
    restart: unless-stopped

  # ==========================================
  # MICROSERVICIO - Producción
  # ==========================================
  microservicio:
    build:
      context: ./microservicio-iso25010
      dockerfile: Dockerfile
    container_name: microservicio-app
    ports:
      - "8080:8080"
    environment:
      # Profile de producción
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=8080

      # Security (cambiar en producción real)
      - JWT_SECRET=${JWT_SECRET:-404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}

      # Features (deshabilitadas en producción)
      - H2_CONSOLE_ENABLED=false
      - SWAGGER_UI_ENABLED=false

      # Logging (productivo)
      - LOG_LEVEL_APP=INFO
      - LOG_LEVEL_WEB=WARN
      - LOG_LEVEL_SQL=WARN

      # CORS restrictivo (configurar según necesidad)
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - prod-network
    restart: unless-stopped
    depends_on:
      jenkins:
        condition: service_healthy

# ==========================================
# VOLÚMENES
# ==========================================
volumes:
  jenkins_home:
    driver: local
    name: jenkins_home_prod
  maven_cache:
    driver: local
    name: maven_cache_prod

# ==========================================
# REDES
# ==========================================
networks:
  prod-network:
    driver: bridge
    name: prod-network
